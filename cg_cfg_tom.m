function job = cg_cfg_tom
% Configuration file for Template-O-Matic toolbox
%_______________________________________________________________________
% Christian Gaser
% $Id$

addpath(fullfile(spm('dir'),'toolbox','TOM'));

% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% GM GM images                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
GM         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
GM.tag     = 'GM';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
GM.name    = 'GM images';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
GM.help    = {'Select GM images (unsmoothed) for estimating regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
GM.filter = 'image';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
GM.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
GM.num     = [1 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% WM WM images                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
WM         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
WM.tag     = 'WM';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
WM.name    = 'WM images';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
WM.val = {''};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
WM.help    = {'Select optional WM images (unsmoothed) for estimating regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
WM.filter = 'image';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
WM.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
WM.num     = [0 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% CSF CSF images                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
CSF         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
CSF.tag     = 'CSF';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
CSF.name    = 'CSF images';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
CSF.val = {''};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
CSF.help    = {'Select optional CSF images (unsmoothed) for estimating regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
CSF.filter = 'image';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
CSF.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
CSF.num     = [0 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% T1 T1 images                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
T1         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
T1.tag     = 'T1';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
T1.name    = 'T1 images';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
T1.val = {''};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
T1.help    = {'Select optional T1 images for estimating regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
T1.filter = 'image';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
T1.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
T1.num     = [0 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% data Data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
data         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
data.tag     = 'data';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
data.name    = 'Data';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
data.val     = {GM WM CSF T1 };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
data.help    = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                'GM images have to be always selected. If you want to use the toolbox '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                'to also create matched tissue maps for white matter, cerebrospinal fluid, or T1 '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                '3D datasets, enter those images (corresponding to the GM images) here. '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                }';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% c Vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
c         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
c.tag     = 'c';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.name    = 'Vector';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
c.help    = {'Vector of covariate values'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
c.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% age Age                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
age         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
age.tag     = 'age';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
age.name    = 'Age';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
age.val     = {c };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
age.help    = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
               'Enter subjects age in years; for increased accuracy, values like '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
               '10.5 or 7.3 are permissable. This field must be filled.'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
               }';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% poly3 Cubic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
poly3         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
poly3.tag     = 'poly3';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
poly3.name    = 'Cubic';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
poly3.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
poly3.help    = {'Model linear, quadratic, and cubic age effects (1st, 2nd, and 3rd order)'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% poly2 Quadratic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
poly2         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
poly2.tag     = 'poly2';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
poly2.name    = 'Quadratic';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
poly2.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
poly2.help    = {'Model linear and quadratic age effects (1st and 2nd order)'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% poly1 Linear                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
poly1         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
poly1.tag     = 'poly1';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
poly1.name    = 'Linear';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
poly1.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
poly1.help    = {'Model only linear age effects (1st order only)'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% poly Order of polynomial age regression?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
poly         = cfg_choice;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
poly.tag     = 'poly';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
poly.name    = 'Order of polynomial age regression?';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
poly.help    = {'Age can be modeled as polynomial regression with up to third order terms. The simplest model is a linear regression (which is not recommended).Either third or second order regression is appropriate for modeling aging effects. The different age terms will be orthogonalized with regard to its preceeding column.'};                                                                                                                                                                                                                                                                    
poly.values  = {poly3 poly2 poly1 };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% c Vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
c         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
c.tag     = 'c';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.name    = 'Vector';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
c.help    = {'Vector of covariate values'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
c.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% gender Gender                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gender         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
gender.tag     = 'gender';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
gender.name    = 'Gender';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
gender.val     = {c };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
gender.help    = {'Enter subjects gender as a vector of 0 (female) and 1 (male).'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% c Vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
c         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
c.tag     = 'c';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.name    = 'Vector';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
c.help    = {'Vector of covariate values'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
c.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% cname Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cname         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
cname.tag     = 'cname';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
cname.name    = 'Name';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cname.help    = {'Name of covariate'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
cname.strtype = 's';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
cname.num     = [1  Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% cov Additional Covariate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cov         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
cov.tag     = 'cov';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
cov.name    = 'Additional Covariate';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
cov.val     = {c cname };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
cov.help    = {'Add a new covariate to your experimental design'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% covariates Covariates                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
covariates         = cfg_repeat;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
covariates.tag     = 'covariates';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
covariates.name    = 'Covariates';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
covariates.help    = {'If you want to model the effects of additional covariates of interests, those can be entered here. Only covariates that explain a substantial amount of variance in the data should be included here. This step is optional.'};                                                                                                                                                                                                                                                                                                                                                        
covariates.values  = {cov };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
covariates.num     = [0 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% odir Output Directory                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
odir         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
odir.tag     = 'odir';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
odir.name    = 'Output Directory';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
odir.val = {{'.'}};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
odir.help    = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                'This defaults to the current work directory. It is, however, a good '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                'idea to create a separate directory with a meaningful name for each project.'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                }';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
odir.filter = 'dir';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
odir.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
odir.num     = [1 1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% estimate Estimate regression parameters                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
estimate         = cfg_exbranch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
estimate.tag     = 'estimate';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
estimate.name    = 'Estimate regression parameters';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
estimate.val     = {data age poly gender covariates odir };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
estimate.check   = @estimate_check;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
estimate.help    = {'Using this option regression parameters of a reference sample (source population)will be estimated.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
estimate.prog    = @(job)cg_tom('estimate',job);
estimate.vout    = @(job)cg_tom_vout('estimate',job);
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% tommat Select TOM.mat                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
tommat         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
tommat.tag     = 'tommat';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
tommat.name    = 'Select TOM.mat';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
tommat.help    = {'Select the TOM.mat file that contains the regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
tommat.filter = 'mat';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
tommat.ufilter = '^TOM\.mat$';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
tommat.num     = [1 1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% matched Matched pairs approach                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
matched         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
matched.tag     = 'matched';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
matched.name    = 'Matched pairs approach';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
matched.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
matched.help    = {'Use matched pairs approach to create template. For this approach the input sample could be completely matched such that one reference tissue map is generated for each input subject. These matched reference maps would only be averaged at the end.'};                                                                                                                                                                                                                                                                                                                                  
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% average Average approach                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
average         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
average.tag     = 'average';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
average.name    = 'Average approach';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
average.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
average.help    = {'Create template based on average age and gender. For this approach you only have to define the average age and gender.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% template Select template creation method                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
template         = cfg_choice;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
template.tag     = 'template';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
template.name    = 'Select template creation method';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
template.help    = {'Two general approaches seem feasible to construct appropriate reference data. First, the average age, gender, etc. is calculated based on the supplied input information (i.e., the demographic variables of the sample under study), and a fitting average template is created accordingly. Here, we term this the average approach. Alternatively, the input sample could be completely matched such that one reference tissue map is generated for each input subject, and these matched reference maps would only be averaged at the end. We term this the matched pairs approach '};
template.values  = {matched average };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% c Vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
c         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
c.tag     = 'c';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.name    = 'Vector';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
c.help    = {'Vector of covariate values'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
c.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% age Age                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
age         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
age.tag     = 'age';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
age.name    = 'Age';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
age.val     = {c };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
age.help    = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
               'Enter subjects age in years; for increased accuracy, values like '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
               '10.5 or 7.3 are permissable. This field must be filled.'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
               }';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% gender_none None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gender_none         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
gender_none.tag     = 'gender_none';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
gender_none.name    = 'None';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
gender_none.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gender_none.help    = {'Do not define gender.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% genderval Gender                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
genderval         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
genderval.tag     = 'genderval';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
genderval.name    = 'Gender';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
genderval.help    = {'Subjects gender can be optionally defined using 0 (female) and 1 (male).'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
genderval.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
genderval.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% newgender Use gender information                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
newgender         = cfg_choice;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
newgender.tag     = 'newgender';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
newgender.name    = 'Use gender information';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
newgender.values  = {gender_none genderval };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% c Vector                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
c         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
c.tag     = 'c';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.name    = 'Vector';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
c.help    = {'Vector of covariate values'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
c.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
c.num     = [Inf    1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% cname Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cname         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
cname.tag     = 'cname';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
cname.name    = 'Name';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cname.help    = {'Name of covariate'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
cname.strtype = 's';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
cname.num     = [1  Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% cov Additional Covariate                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
cov         = cfg_branch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
cov.tag     = 'cov';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
cov.name    = 'Additional Covariate';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
cov.val     = {c cname };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
cov.help    = {'Add a new covariate to your experimental design'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% covariates Covariates                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
covariates         = cfg_repeat;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
covariates.tag     = 'covariates';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
covariates.name    = 'Covariates';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
covariates.help    = {'If you want to model the effects of additional covariates of interests, those can be entered here. Only covariates that explain a substantial amount of variance in the data should be included here. This step is optional.'};                                                                                                                                                                                                                                                                                                                                                        
covariates.values  = {cov };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
covariates.num     = [0 Inf];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% gif_none None                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gif_none         = cfg_const;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
gif_none.tag     = 'gif_none';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
gif_none.name    = 'None';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
gif_none.val = {[]};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
gif_none.help    = {'Do not save animated gif-image'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% gifslice Transversal slice (in mm)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gifslice         = cfg_entry;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
gifslice.tag     = 'gifslice';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
gifslice.name    = 'Transversal slice (in mm)';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
gifslice.val = {0};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
gifslice.help    = {'Select slice (in mm) for animated gif-image.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
gifslice.strtype = 'e';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gifslice.num     = [1  1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% gif Save animated gif-image                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
gif         = cfg_choice;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
gif.tag     = 'gif';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
gif.name    = 'Save animated gif-image';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
gif.values  = {gif_none gifslice };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% odir Output Directory                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
odir         = cfg_files;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
odir.tag     = 'odir';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
odir.name    = 'Output Directory';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
odir.val = {{'.'}};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
odir.help    = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                'This defaults to the current work directory. It is, however, a good '                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                'idea to create a separate directory with a meaningful name for each project.'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                }';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
odir.filter = 'dir';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
odir.ufilter = '.*';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
odir.num     = [1 1];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% create Create new template                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
create         = cfg_exbranch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
create.tag     = 'create';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
create.name    = 'Create new template';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
create.val     = {tommat template age newgender covariates gif odir };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
create.check   = @create_check;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
create.help    = {'Create template for the target population from previously estimated regression parameters.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
create.prog    = @(job)cg_tom('create',job);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
create.vout    = @(job)cg_tom_vout('create',job);
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% tommat Select TOM.mat                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
tommat         = cfg_files;
tommat.tag     = 'tommat';
tommat.name    = 'Select TOM.mat';
tommat.help    = {'Select the TOM.mat file that contains the regression parameters.'};
tommat.filter = 'mat';
tommat.ufilter = '^TOM\.mat$';
tommat.num     = [1 1];
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% getinfo Print information about TOM.mat                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
getinfo         = cfg_exbranch;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
getinfo.tag     = 'getinfo';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
getinfo.name    = 'Print information about TOM.mat';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
getinfo.val     = {tommat };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
getinfo.help    = {'Print information about an already estimated regression.'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
getinfo.prog = @(job)cg_tom('getinfo',job);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
% tom Template-O-Matic                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
% ---------------------------------------------------------------------                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
job         = cfg_choice;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
job.tag     = 'tom';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
job.name    = 'Template-O-Matic';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
job.help    = {'Help needed'};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
job.values  = {estimate create getinfo };                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      

return;

%-------------------------------------------------------------------------

function t = create_check(job)
t = {};

load(job.tommat{:});

newage = job.age.c;
newcovs = job.cov;
n_newcovs = length(newcovs);
if isfield(job.newgender,'val')
  newgender = job.newgender.val;
else
  newgender = [];
end

if ~isempty(newgender)
  if (size(newgender,1)~=size(newage,1))
    t = {sprintf('Number of age values differ from number of gender values.')};
  end
  if (max(newgender) > 1) | (min(newgender) < 0)
    t = {t{:}, sprintf('Valid values for gender are 1 for males and 0 for females.')};
  end
end

for i = 1:n_newcovs
    if size(newage,1)~=size(newcovs(i).c,1)
    t = {t{:}, sprintf('Number of %s differ from number of images.',newcovs(i).cname)};
  end
end

% check age range
if max(newage) > max(age)
  t = {t{:}, sprintf('%3.2f is outside of the age range used for calculating the age regression (%3.2f..%3.2f years)\n',...
	  max(newage),min(age),max(age))};
end
if min(newage) < min(age)
  t = {t{:}, sprintf('%3.2f is outside of the age range used for calculating the age regression (%3.2f..%3.2f years)\n',...
    min(newage),min(age),max(age))};
end
  
% too many new covariates?
if n_newcovs > length(covs)
  t = {t{:}, sprintf('You have more covariates defined as used in the estimated model.')};
end

return

%-------------------------------------------------------------------------

%-------------------------------------------------------------------------

function t = estimate_check(job)
t = {};

GM  = job.data.GM;
WM  = job.data.WM;
CSF = job.data.CSF;
T1  = job.data.T1;
data = {GM, WM, CSF, T1};

modi = {'GM','WM','CSF','T1'};
n_covs  = length(job.cov);
n_modi = zeros(1,4);
for i=1:4
  n_modi(i) = length(data{i});
  % correct if entry is empty
  if strcmp(data{i},''), n_modi(i) = 0; end
end

% check for same file numbers
if any(diff(n_modi(find(n_modi>0)))), t = {sprintf('Number of GM/WM/CSF/T1 images differ.\n')}; end

% check for correct number of covariates
if n_modi(1)~=size(job.age.c,1), t = {t{:}, sprintf('Number of age values differ from number of images.\n')}; end
if n_modi(1)~=size(job.gender.c,1), t = {t{:}, sprintf('Number of gender values differ from number of images.\n')}; end
for i = 1:n_covs
  if n_modi(1)~=size(job.cov(i).c,1)
    t = {t{:}, sprintf('Number of %s differ from number of images.\n',job.cov(i).cname)};
  end
end

if (min(job.gender.c)<0) | (max(job.gender.c)>1)
  t = {t{:}, sprintf('Valid values for gender are 1 for males and 0 for females.')};
end

return

%-------------------------------------------------------------------------

function dep = cg_tom_vout(cmd, job) %#ok<INUSD>
switch lower(cmd)
    case 'estimate',
        dep(1)            = cfg_dep;
        dep(1).sname      = 'TOM.mat';
        dep(1).src_output = substruct('.','tommat');
        dep(1).tgt_spec   = cfg_findspec({{'strtype','e','filter','mat'}});
        dep(2)            = cfg_dep;
        dep(2).sname      = 'Beta images';
        dep(2).src_output = substruct('.','betas');
        dep(2).tgt_spec   = cfg_findspec({{'strtype','e','filter','image'}});
    case 'create',
        dep(1)            = cfg_dep;
        dep(1).sname      = 'Template images';
        dep(1).src_output = substruct('.','templates');
        dep(1).tgt_spec   = cfg_findspec({{'strtype','e','filter','image'}});
    otherwise
        error('cg_tom:vout','No virtual outputs defined for ''%s''.', cmd);
end